DELIMITER $$

CREATE OR REPLACE FUNCTION digito_verifica(nit BIGINT)
RETURNS INT
DETERMINISTIC
BEGIN
    DECLARE dv INT;
    DECLARE suma BIGINT DEFAULT 0;
    DECLARE residuo INT;
    DECLARE i INT DEFAULT 1;
    DECLARE longitud INT;
    DECLARE digito INT;

    -- Factores correspondientes
    DECLARE f1 INT DEFAULT 71;
    DECLARE f2 INT DEFAULT 67;
    DECLARE f3 INT DEFAULT 59;
    DECLARE f4 INT DEFAULT 53;
    DECLARE f5 INT DEFAULT 47;
    DECLARE f6 INT DEFAULT 43;
    DECLARE f7 INT DEFAULT 41;
    DECLARE f8 INT DEFAULT 37;
    DECLARE f9 INT DEFAULT 29;

    -- Determinar longitud del NIT
    SET longitud = LENGTH(nit);

    -- Iterar sobre los dígitos del NIT
    WHILE i <= longitud DO
        -- Obtener el dígito de derecha a izquierda y convertirlo en número
        SET digito = CAST(SUBSTRING(nit, longitud - i + 1, 1) AS UNSIGNED);

        -- Multiplicar el dígito por el factor correspondiente
        IF i = 1 THEN
            SET suma = suma + digito * f1;
        ELSEIF i = 2 THEN
            SET suma = suma + digito * f2;
        ELSEIF i = 3 THEN
            SET suma = suma + digito * f3;
        ELSEIF i = 4 THEN
            SET suma = suma + digito * f4;
        ELSEIF i = 5 THEN
            SET suma = suma + digito * f5;
        ELSEIF i = 6 THEN
            SET suma = suma + digito * f6;
        ELSEIF i = 7 THEN
            SET suma = suma + digito * f7;
        ELSEIF i = 8 THEN
            SET suma = suma + digito * f8;
        ELSEIF i = 9 THEN
            SET suma = suma + digito * f9;
        END IF;

        SET i = i + 1;
    END WHILE;

    -- Calcular el residuo
    SET residuo = suma MOD 11;

    -- Determinar el dígito de verificación
    IF residuo = 0 OR residuo = 1 THEN
        SET dv = 0;
    ELSE
        SET dv = 11 - residuo;
    END IF;

    RETURN dv;
END $$

DELIMITER ;
